<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Your Move</title>
    <link rel="icon" type="image/x-icon" href="./favicon.ico">
  </head>
  <body>
  </body>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    function toJSON(resp){
      return resp.json();
    }

    function see(label){
      return function(...args){
        return console.log(label, ...args);
      }
    }

    const {supabaseUrl, supabaseKey, options} = await fetch("https://config.workers.yourmove.cc", {
      mode: "cors",
      headers: {
        "accept": "application/json",
        "content-type": "application/json; charset=UTF-8"
      }
    }).then(toJSON);

    const supabase = createClient(supabaseUrl, supabaseUrl, options);
    console.log('supabase', supabase);

    function data(resp){
      return resp.data;
    }

    if (supabase.auth.currentUser) {
      supabase
        .from("tables")
        .select()
        .then(see("select:supabase:tables"));

      supabase
        .from("events")
        .select()
        .then(see("select:supabase:events"));

      const sub = supabase
        .from("tables")
        .on("*", see("subscribe:supabase:tables"))
        .subscribe();

      const worker = "https://oh-hell.workers.yourmove.cc?table_id=823Wonk34yU";
      const headers = {
        "accept": "application/json",
        "content-type": "application/json; charset=UTF-8",
        "authorization": `Bearer ${supabase.auth?.currentSession?.access_token}`.trim(),
        "apikey": supabaseKey
      };
      fetch(worker, {
        headers
      }).then(toJSON).then(see("get:workers:events:oh-hell"));

      fetch(worker, {
        method: "POST",
        headers,
        body: JSON.stringify({
          command: "start"
        })
      }).then(see("post:workers:events:oh-hell"));

      fetch(worker, {
        method: "PATCH",
        headers,
        body: JSON.stringify({
          command: "start"
        })
      }).then(see("patch:workers:events:oh-hell"));

      fetch(`${supabaseUrl}/rest/v1/tables?select=*`, {headers}).then(toJSON).then(see("get:supabase:tables"));
    }
  </script>
</html>
